<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Kart-Quiz</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root { --border:#d0d7de }
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial}
    header{padding:8px 12px;display:flex;gap:8px;align-items:center;border-bottom:1px solid var(--border)}
    #map{height:70vh; touch-action: manipulation;} /* bättre mobil-klick */
    .pill{border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px}
    .box{padding:8px 12px}
    input,select,button{padding:6px 8px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .muted{color:#666;font-size:12px}
    button{cursor:pointer}
    .hidden{display:none}
    #players{font-size:12px;color:#444}
    #credit{position:fixed;right:10px;bottom:8px;opacity:.5;font-size:12px;pointer-events:none}
  </style>
</head>
<body>
  <header class="row">
    <strong>Live Kart-Quiz</strong>
    <span id="status" class="muted">Inte ansluten</span>
    <span class="pill" id="timer">⏱ —</span>
  </header>

  <div class="box">
    <div class="row">
      <input id="serverUrl" class="hidden" />
      <label>Roll:</label>
      <select id="role">
        <option value="player">Spelare</option>
        <option value="host">Host</option>
      </select>
      <span class="pill" id="gameCode">Kod: —</span>
    </div>

    <div id="hostPanel" class="row" style="margin-top:6px;display:none">
      <input id="cityName" placeholder="Skriv stad (t.ex. Linköping)" />
      <button id="startRound" disabled>Starta runda</button>
      <button id="nextRound" disabled>Nästa runda</button>
      <button id="endGame">Avsluta spel</button>
    </div>

    <div id="playerPanel" class="row" style="margin-top:6px">
      <input id="joinCode" placeholder="Kod (6 siffror)" />
      <input id="playerName" placeholder="Ditt namn" />
      <button id="joinBtn">Gå med</button>
    </div>

    <div class="row" style="margin-top:6px; align-items:flex-start">
      <span class="pill" id="prompt">—</span>
      <span class="pill" id="totalMe">Totalt: 0.0 km</span>
      <div id="players" class="hidden"></div>
    </div>
  </div>

  <div id="map"></div>

  <div class="box">
    <div id="results" class="muted">Resultat visas här efter varje runda.</div>
  </div>

  <div id="credit">Ett spel av Jesper Pettersson</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    // Din Render-URL
    const SERVER_URL = "https://geo-live-server.onrender.com";

    // Låsning till hela världen (ingen kopia av Europa), fri zoom
    const worldBounds = L.latLngBounds(L.latLng(-85, -180), L.latLng(85, 180));
    const map = L.map('map', {
      zoomControl: true,
      attributionControl: false,
      minZoom: 1,
      maxBounds: worldBounds,
      maxBoundsViscosity: 1.0,
      worldCopyJump: false
    }).setView([25, 10], 2);
    map.setMaxBounds(worldBounds);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
      maxZoom: 19,
      subdomains: 'abcd',
      noWrap: true,
      bounds: worldBounds,
      attribution: '© OpenStreetMap, © CARTO'
    }).addTo(map);

    // Rensningslager per runda
    let roundLayer = L.layerGroup().addTo(map);

    // UI
    const status = document.getElementById('status');
    const roleSel = document.getElementById('role');
    const hostPanel = document.getElementById('hostPanel');
    const playerPanel = document.getElementById('playerPanel');
    const gameCode = document.getElementById('gameCode');
    const cityName = document.getElementById('cityName');
    const startRound = document.getElementById('startRound');
    const nextRound = document.getElementById('nextRound');
    const endGame = document.getElementById('endGame');
    const joinCode = document.getElementById('joinCode');
    const playerName = document.getElementById('playerName');
    const joinBtn = document.getElementById('joinBtn');
    const promptEl = document.getElementById('prompt');
    const totalMe = document.getElementById('totalMe');
    const resultsEl = document.getElementById('results');
    const timerEl = document.getElementById('timer');
    const playersDiv = document.getElementById('players');

    // State
    let socket = null, gameId = null, myRole = 'player', myPlayerName = '', myTotal = 0;
    let deadlineAt = null, timerTick = null;

    // Roll
    roleSel.onchange = () => {
      myRole = roleSel.value;
      hostPanel.style.display = myRole === 'host' ? '' : 'none';
      playerPanel.style.display = myRole === 'player' ? '' : 'none';
      playersDiv.classList.toggle('hidden', myRole !== 'host');
      if (myRole === 'host') ensureConnectedAndCreate();
    };
    roleSel.onchange();

    // Anslut
    function connect() {
      if (socket) return true;
      socket = io(SERVER_URL, { transports: ['websocket'] });
      socket.on('connect', () => status.textContent = 'Ansluten');
      socket.on('disconnect', () => status.textContent = 'Inte ansluten');

      socket.on('game:created', ({ gameId: gid, code }) => {
        gameId = gid;
        gameCode.textContent = 'Kod: ' + code;
        startRound.disabled = false;
      });
      socket.on('player:joined', ({ gameId: gid }) => { gameId = gid; });

      socket.on('lobby:update', ({ players }) => {
        if (myRole !== 'host') return;
        const names = players.map(p => p.name).join(' · ');
        playersDiv.innerHTML = names ? `<span class="pill">Spelare: ${names}</span>` : '';
      });

      socket.on('round:started', ({ round, cityName, deadlineAt: dl }) => {
        roundLayer.clearLayers();
        promptEl.textContent = `Runda ${round}: ${cityName} – gissa på kartan!`;
        resultsEl.textContent = 'Rundan pågår...';
        deadlineAt = dl;
        nextRound.disabled = true;
        if (timerTick) clearInterval(timerTick);
        timerTick = setInterval(()=> {
          const s = Math.max(0, Math.ceil((deadlineAt - Date.now())/1000));
          timerEl.textContent = '⏱ ' + s + 's';
        }, 200);
      });

      socket.on('guess:accepted', ({ km }) => {
        resultsEl.textContent = `Din gissning: ${km} km`;
      });

      socket.on('round:results', ({ city, results }) => {
        if (timerTick) { clearInterval(timerTick); timerTick = null; timerEl.textContent = '⏱ —'; }

        L.marker([city.lat, city.lng]).addTo(roundLayer).bindPopup(`Facit: ${city.name}`).openPopup();
        L.circle([city.lat, city.lng], { radius: 10000, color: '#7cc5ff', weight: 1, dashArray: '4 4' }).addTo(roundLayer);

        resultsEl.innerHTML = '<strong>Resultat:</strong><br/>' +
          results.map(r => `${r.name}: ${r.km} km (totalt ${r.totalKm} km)`).join('<br/>');

        const me = results.find(r => r.name === myPlayerName);
        if (me) { myTotal = me.totalKm; totalMe.textContent = 'Totalt: ' + myTotal + ' km'; }

        results.forEach(r => {
          if (r.guess) {
            L.circleMarker([r.guess.lat, r.guess.lng], { radius: 7, weight: 2, color: '#000', fillColor: '#7cc5ff', fillOpacity: 0.9 }).addTo(roundLayer);
            L.polyline([[r.guess.lat, r.guess.lng],[city.lat, city.lng]], { weight:2, opacity:.7, dashArray:'4 6' }).addTo(roundLayer);
          }
        });

        if (myRole === 'host') nextRound.disabled = false;
        promptEl.textContent = 'Runda klar.';
      });

      socket.on('lobby:ready', () => {
        roundLayer.clearLayers();
        promptEl.textContent = 'Redo för nästa runda.';
        resultsEl.textContent = '—';
      });

      socket.on('game:final', ({ leaderboard }) => {
        resultsEl.innerHTML = '<strong>Slutställning</strong><br/>' +
          leaderboard.map((r,i)=> `${i+1}. ${r.name} – ${r.totalKm} km`).join('<br/>');
      });

      socket.on('round:error', ({ message }) => alert(message || 'Fel vid start av runda'));
      return true;
    }

    // Host: skapa spel när host-läge väljs
    function ensureConnectedAndCreate() {
      if (!connect()) return;
      socket.emit('host:createGame', { roundTimeSec: 20, penaltyKm: 20000 });
    }

    // Host: starta runda (geokodar stad på servern)
    startRound.onclick = () => {
      const name = (cityName.value || '').trim();
      if (!name) return alert('Skriv en stad, t.ex. Linköping');
      socket.emit('host:startRound', { gameId, cityName: name });
      startRound.disabled = true; nextRound.disabled = true;
    };
    nextRound.onclick = () => { socket.emit('host:nextRound', { gameId }); startRound.disabled = false; };
    endGame.onclick = () => { socket.emit('host:endGame', { gameId }); };

    // Spelare: gå med
    joinBtn.onclick = () => {
      if (!connect()) return;
      const code = (joinCode.value || '').replace(/\D/g,'');
      if (!code) return alert('Skriv koden (6 siffror).');
      myPlayerName = (playerName.value || 'Spelare').trim();
      socket.emit('player:join', { code, name: myPlayerName });
    };

    // Spelare: klick på kartan = gissning
    map.on('click', (e) => {
      if (myRole === 'player' && gameId && socket) {
        socket.emit('player:submitGuess', { gameId, lat: e.latlng.lat, lng: e.latlng.lng });
      }
    });
  </script>
</body>
</html>
